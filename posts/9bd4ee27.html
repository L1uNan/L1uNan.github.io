<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>elasticsearch建议器 | NanPy</title><meta name="description" content="elasticsearch建议器"><meta name="keywords" content="ElasticSearch"><meta name="author" content="L1uNan"><meta name="copyright" content="L1uNan"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/gtx.png"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="elasticsearch建议器"><meta name="twitter:description" content="elasticsearch建议器"><meta name="twitter:image" content="http://cnd.nanpy.top/post11.jpg"><meta property="og:type" content="article"><meta property="og:title" content="elasticsearch建议器"><meta property="og:url" content="http://nanpy.top/posts/9bd4ee27.html"><meta property="og:site_name" content="NanPy"><meta property="og:description" content="elasticsearch建议器"><meta property="og:image" content="http://cnd.nanpy.top/post11.jpg"><script src="https://cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.css"><link rel="canonical" href="http://nanpy.top/posts/9bd4ee27.html"><link rel="prev" title="python的GIL是什么东西？" href="http://nanpy.top/posts/a3a30c9.html"><link rel="next" title="分页器封装" href="http://nanpy.top/posts/5dd0a337.html"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://xxx/","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: {"bookmark":{"message_prev":"按","message_next":"键将本页加入书签"},"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="NanPy" type="application/atom+xml">
</head><body><canvas class="fireworks"></canvas><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="http://cnd.nanpy.top/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">46</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">36</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">18</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/heart/"><i class="fa-fw fa fa-heartbeat"></i><span> 点点</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-gamepad" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-headphones"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-camera"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-grav"></i><span> 关于我</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#什么是建议器"><span class="toc-number">1.</span> <span class="toc-text">什么是建议器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建议器如何使用"><span class="toc-number">2.</span> <span class="toc-text">建议器如何使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#query与suggest结合"><span class="toc-number">2.1.</span> <span class="toc-text">query与suggest结合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接使用-suggest"><span class="toc-number">2.2.</span> <span class="toc-text">直接使用 suggest</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#建议器种类"><span class="toc-number">3.</span> <span class="toc-text">建议器种类</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#词条建议器（term-suggester）"><span class="toc-number">3.1.</span> <span class="toc-text">词条建议器（term suggester）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#选择哪些词条被建议"><span class="toc-number">3.1.1.</span> <span class="toc-text">选择哪些词条被建议</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#词组建议器（phrase-suggester）"><span class="toc-number">3.2.</span> <span class="toc-text">词组建议器（phrase suggester）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#完成建议器（completion-suggester）"><span class="toc-number">3.3.</span> <span class="toc-text">完成建议器（completion suggester）</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#前言"><span class="toc-number">3.3.1.</span> <span class="toc-text">前言</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在索引阶段提升相关性"><span class="toc-number">3.3.2.</span> <span class="toc-text">在索引阶段提升相关性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#在搜索阶段提升相关性"><span class="toc-number">3.3.3.</span> <span class="toc-text">在搜索阶段提升相关性</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#其他"><span class="toc-number">3.3.4.</span> <span class="toc-text">其他</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(http://cnd.nanpy.top/post11.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="/">NanPy</a></span><span class="pull_right menus"><div id="search_button"><a class="site-page social-icon search"><i class="fa fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fa fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fa fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fa fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="/heart/"><i class="fa-fw fa fa-heartbeat"></i><span> 点点</span></a></div><div class="menus_item"><a class="site-page"><i class="fa-fw fa fa-gamepad" aria-hidden="true"></i><span> 娱乐</span><i class="fa fa-chevron-down menus-expand" aria-hidden="true"></i></a><ul class="menus_item_child"><li><a class="site-page" href="/music/"><i class="fa-fw fa fa-headphones"></i><span> 音乐</span></a></li><li><a class="site-page" href="/Gallery/"><i class="fa-fw fa fa-camera"></i><span> 照片</span></a></li><li><a class="site-page" href="/movies/"><i class="fa-fw fa fa-film"></i><span> 电影</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fa fa-grav"></i><span> 关于我</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">elasticsearch建议器</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date" title="发表于 2020-05-08 15:59:20"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-05-08</time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/ElasticSearch/">ElasticSearch</a></span></div><div class="meta-secondline"> <span class="post-meta-wordcount"><i class="post-meta__icon fa fa-file-word-o" aria-hidden="true"></i><span>字数总计:</span><span class="word-count">5.1k</span><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-clock-o" aria-hidden="true"></i><span>阅读时长: 18 分钟</span></span></div><div class="meta-thirdline"><span class="post-meta-pv-cv"><span class="post-meta__separator">|</span><i class="fa fa-eye post-meta__icon" aria-hidden="true"> </i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span><span class="post-meta-commentcount"><span class="post-meta__separator">|</span><i class="post-meta__icon fa fa-comment-o" aria-hidden="true"></i><span>评论数:</span><a href="/posts/9bd4ee27.html#post-comment" itemprop="discussionUrl"><span class="valine-comment-count comment-count" data-xid="/posts/9bd4ee27.html" itemprop="commentCount"></span></a></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><h2 id="什么是建议器">什么是建议器</h2>
<p>目前为止，浏览器都已经具备<code>Suggest as you type</code>功能，即在我们输入搜索的过程中，进行自动的补全或者纠错功能，协助用户输入更精确的关键词，提高搜索阶段的文档匹配程度。例如我们在百度或谷歌浏览器输入搜索关键词时，虽然我们输入的有误，但是浏览器依然能够提示出我们想要的正确结果。<br>
<img src="/img/loading.gif" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200506185947444.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzE5OTEwMw==,size_16,color_FFFFFF,t_70"  alt="在这里插入图片描述"></p>
<p><img src="/img/loading.gif" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200506190050554.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzE5OTEwMw==,size_16,color_FFFFFF,t_70"  alt="![在这里插入图片描述](https://img-blog.csdnimg.cn/2020050619002368.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzE5OTEwMw==,size_16,color_FFFFFF,t_70"><br>
<strong>在elasticsearch中，建议功能通过使用建议器基于提供的文本建议类似的词</strong><br>
目前<code>_suggest</code>已经弃用，我们可以通过<code>_search</code>来做建议器的查询。<br>
在5.0版本中，<code>_search</code>经过优化，变得非常的方便。</p>
<h2 id="建议器如何使用">建议器如何使用</h2>
<h3 id="query与suggest结合">query与suggest结合</h3>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">PUT s1</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "doc": {</span><br><span class="line">      "properties": {</span><br><span class="line">        "title": {</span><br><span class="line">          "type": "text",</span><br><span class="line">          "analyzer": "standard"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s1/doc/1</span><br><span class="line">{</span><br><span class="line">  "title": "Lucene is cool"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s1/doc/2</span><br><span class="line">{</span><br><span class="line">  "title":"Elasticsearch builds on top of lucene"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET s1/doc/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "title": "Lucene"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_suggest": {</span><br><span class="line">      "text": "Elasticsear lucen",</span><br><span class="line">      "term": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><img src="/img/loading.gif" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200506192346470.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzE5OTEwMw==,size_16,color_FFFFFF,t_70"  alt="在这里插入图片描述"></p>
<p>上例是一个包含建议的查询请求，查询<code>query</code>我们已经了然。<br>
让我们注意<code>suggest</code>，每个建议器都有自己名称<code>my-suggestion</code>，es根据text字段返回建议结果。建议类型是<code>term</code>。从<code>field</code>字段生成建议。</p>
<h3 id="直接使用-suggest">直接使用 suggest</h3>
<p>如果我们仅需要建议而不需要查询功能，我们可以忽略<code>query</code>而直接使用<code>suggest</code>对象返回建议。</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET s1/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_sugget": {</span><br><span class="line">      "text": "Elasticsear lucen",</span><br><span class="line">      "term": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可以根据需要指定几组建议器，每组建议器都有自己的名称。如下例的<code>my_suggest1</code>和<code>my_suggest2</code>。</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET s1/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_sugget1": {</span><br><span class="line">      "text": "Elasticsear",</span><br><span class="line">      "term": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "my_suggest2": {</span><br><span class="line">      "text": "lucen",</span><br><span class="line">      "term": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>在多个建议器中，如果输入的<code>text</code>字段值一致，可以单独写出来，以适用于<code>my_suggest1</code>和<code>my_suggest2</code>两个建议器。</p>
<figure class="highlight html"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">GET s1/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "text": "Elasticsear lucen",</span><br><span class="line">    "my_sugget1": {</span><br><span class="line">      "term": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    },</span><br><span class="line">    "my_suggest2": {</span><br><span class="line">      "term": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="建议器种类">建议器种类</h2>
<p>根据需求不同<code>elasticsearch</code>设计了4种<code>suggester</code>，分别是：</p>
<ul>
<li>词条建议器（<code>term suggester</code>）：主要做<strong>纠正</strong>。对于给定文本的每个词条，该键议器从索引中抽取要建议的关键词，这对于短字段（如分类标签）很有效。</li>
<li>词组建议器（<code>phrase suggester</code>）：主要做<strong>纠正</strong>。我们可以认为它是词条建议器的扩展，为整个文本（而不是单个词条）提供了替代方案，它考虑了各词条彼此临近出现的频率，使得该建议器更适合较长的字段，比如商品的描述。</li>
<li>完成建议器（<code>completion suggester</code>）：该建议器根据词条的前缀，提供自动完成的功能（智能提示，有点最左前缀查询的意思），为了实现这种实时的建议功能，它得到了优化，工作在内存中。所以，速度要比之前说的<code>match_phrase_prefix</code>快的多！</li>
<li>上下文建议器（<code>context suggester</code>）：它是完成建议器的扩展，允许我们根据词条或分类亦或是地理位置对结果进行过滤。</li>
</ul>
<h3 id="词条建议器（term-suggester）">词条建议器（<code>term suggester</code>）</h3>
<p>词条建议器接收输入的文本，对其进行分析并且分为词条，然后为每个词条提供一系列的建议。</p>
<p><strong>测试数据：创建索引，创建文档。</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">PUT s2</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "doc": {</span><br><span class="line">      "properties": {</span><br><span class="line">        "title": {</span><br><span class="line">          "type": "text",</span><br><span class="line">          "analyzer": "standard"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s2/doc/1</span><br><span class="line">{</span><br><span class="line">  "title": "Lucene is cool"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s2/doc/2</span><br><span class="line">{</span><br><span class="line">  "title": "Elasticsearch builds on top of lucene"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s2/doc/3</span><br><span class="line">{</span><br><span class="line">  "title": "Elasticsearch rocks"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s2/doc/4</span><br><span class="line">{</span><br><span class="line">  "title": "Elastic is the company behind ELK stack"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s2/doc/5</span><br><span class="line">{</span><br><span class="line">  "title": "elk rocks"</span><br><span class="line">}</span><br><span class="line">PUT s2/doc/6</span><br><span class="line">{</span><br><span class="line">  "title": "elasticsearch is rock solid"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>查询：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET s2/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_suggest": {</span><br><span class="line">      "text": "luenc",</span><br><span class="line">      "term": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>返回结果：</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 3,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "successful" : 5,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : 0,</span><br><span class="line">    "max_score" : 0.0,</span><br><span class="line">    "hits" : [ ]</span><br><span class="line">  },</span><br><span class="line">  "suggest" : {</span><br><span class="line">    "my_suggest" : [</span><br><span class="line">      {</span><br><span class="line">        "text" : "luenc",</span><br><span class="line">        "offset" : 0,</span><br><span class="line">        "length" : 5,</span><br><span class="line">        "options" : [</span><br><span class="line">          {</span><br><span class="line">            "text" : "lucene",</span><br><span class="line">            "score" : 0.6,</span><br><span class="line">            "freq" : 2</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>上例中，在<code>options</code>字段中，建议结果是<code>lucene</code>。我们来看看，在建议器中，都有哪些字段。</p>
<p><code>text</code>：建议文本，建议文本是必需的选项，可以通过全局（多个建议器中查询相同的内容）或者按照单个建议器的格式来。<br>
<code>field</code>：从<code>field</code>字段中获取候选建议的字段。这是一个必需的选项，需要全局设置或根据建议设置。<br>
<code>analyzer</code>：用于分析建议文本的分析器。默认为建议字段的搜索分析器。<br>
<code>size</code>：个建议文本标记返回的最大条目。<br>
<code>sort</code>：定义如何根据建议文本术语对建议进行排序。它有两个可能的值。<br>
<code>score</code>，先按分数排序，然后按文档频率排序，再按术语本身排序。<br>
<code>frequency</code>，首先按文档频率排序，然后按相似性分数排序，然后按术语本身排序。也可以理解为按照流行度排序。<br>
<code>suggest_mode</code>：控制建议的模式，有3个模式可选择。</p>
<ul>
<li><code>missing</code>，仅为不在索引中的建议文本术语提供建议。这是默认值。</li>
<li><code>popular</code>，仅建议在比原始建议文本术语更多的文档中出现的建议。也就是说提供比原有输入词频更高的词条</li>
<li><code>always</code>，根据建议文本中的条款建议任何匹配的建议。说白了就是无论如何都会提供建议。</li>
</ul>
<p><code>lowercase_terms</code>：在文本分析之后降低建议文本术语的大小写。<br>
<code>min_word_length</code>：建议文本术语必须具有的最小长度才能包含在内。默认为4.（旧名称<code>min_word_len</code>已弃用）。<br>
<code>shard_size</code>：设置从每个单独分片中检索的最大建议数。在减少阶段，仅根据<code>size</code>选项返回前N个建议。默认为该 <code>size</code>选项。将此值设置为高于该值的值<code>size</code>可能非常有用，以便以性能为代价获得更准确的拼写更正文档频率。由于术语在分片之间被划分，因此拼写校正频率的分片级文档可能不准确。增加这些将使这些文档频率更精确。<br>
<code>max_inspections</code>：用于乘以的因子， <code>shards_size</code>以便在碎片级别上检查更多候选拼写更正。可以以性能为代价提高准确性。默认为5。<br>
<code>string_distance</code>：用于比较类似建议术语的字符串距离实现。<br>
<code>internal</code>，默认值基于<code>damerau_levenshtein</code>，但高度优化用于比较索引中术语的字符串距离。<br>
<code>damerau_levenshtein</code>，基于<code>Damerau-Levenshtein</code>算法的字符串距离算法。<br>
<code>levenshtein</code>，基于<code>Levenshtein</code>编辑距离算法的字符串距离算法。<br>
<code>jaro_winkler</code>，基于<code>Jaro-Winkler</code>算法的字符串距离算法。<br>
<code>ngram</code>，基于字符<code>n-gram</code>的字符串距离算法。</p>
<p>了解了各字段的大致含义，我们来探讨一下，词条建议器是如何运作的。以便理解如何确定哪些建议将成为第一名。</p>
<h4 id="选择哪些词条被建议">选择哪些词条被建议</h4>
<p>词条建议器使用了<code>Lucene</code>的错拼检查器模块，该模块会根据给定词条的<strong>编辑距离</strong>（es使用了叫做Levenstein edit distance的算法，其核心思想就是一个词改动多少字符就可以和另外一个词一致），从索引中返回最大编辑距离不超过某个值的那些词条。比如说为了从<code>mik</code>得到<code>mick</code>，需要加入一个字母（也就是说需要至少要改动一次），所以这两个词的编辑距离就是1。我们可以通过配置一系列的选项，来均衡灵活和性能：</p>
<ul>
<li>max_edits：最大编辑距离候选建议可以具有以便被视为建议。只能是介于1和2之间的值。任何其他值都会导致抛出错误的请求错误。默认为2。</li>
<li>prefix_length：必须匹配的最小前缀字符的数量才是候选建议。默认为1.增加此数字可提高拼写检查性能。通常拼写错误不会出现在术语的开头。（旧名<code>prefix_len</code>已弃用）。</li>
<li>min_doc_freq：建议应出现的文档数量的最小阈值。可以指定为绝对数字或文档数量的相对百分比。这可以仅通过建议高频项来提高质量。默认为0f且未启用。如果指定的值大于1，则该数字不能是小数。分片级文档频率用于此选项。</li>
<li>max_term_freq：建议文本令牌可以存在的文档数量的最大阈值，以便包括在内。可以是表示文档频率的相对百分比数（例如0.4）或绝对数。如果指定的值大于1，则不能指定小数。默认为0.01f。这可用于排除高频术语的拼写检查。高频术语通常拼写正确，这也提高了拼写检查的性能。分片级文档频率用于此选项。</li>
</ul>
<p>小结，<code>term suggester</code>首先将输入文本经过分析器（所以，分析结果由于采用的分析器不同而有所不同）分析，处理为单个词条，然后根据单个词条去提供建议，并不会考虑多个词条之间的关系。然后将每个词条的建议结果（有或没有）封装到<code>options</code>列表中。最后由建议器统一返回。</p>
<h3 id="词组建议器（phrase-suggester）">词组建议器（<code>phrase suggester</code>）</h3>
<p>词组建议器和词条建议器一样，不过它不再为单个词条提供建议，而是为整个文本提供建议。</p>
<p><strong>测试数据：创建索引，创建文档。</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">PUT s4</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "doc": {</span><br><span class="line">      "properties": {</span><br><span class="line">        "title": {</span><br><span class="line">          "type": "text",</span><br><span class="line">          "analyzer": "standard"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s4/doc/1</span><br><span class="line">{</span><br><span class="line">  "title": "Lucene is cool"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s4/doc/2</span><br><span class="line">{</span><br><span class="line">  "title": "Elasticsearch builds on top of lucene"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s4/doc/3</span><br><span class="line">{</span><br><span class="line">  "title": "Elasticsearch rocks"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s4/doc/4</span><br><span class="line">{</span><br><span class="line">  "title": "Elastic is the company behind ELK stack"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s4/doc/5</span><br><span class="line">{</span><br><span class="line">  "title": "elk rocks"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s4/doc/6</span><br><span class="line">{</span><br><span class="line">  "title": "elasticsearch is rock solid"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><strong>查询</strong></p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET s4/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s4": {</span><br><span class="line">      "text": "lucne and elasticsear rock",</span><br><span class="line">      "phrase": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>text</code>是输入带有拼错的文本。而建议类型则换成了<code>phrase</code>。来看查询结果：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 6,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "successful" : 5,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : 0,</span><br><span class="line">    "max_score" : 0.0,</span><br><span class="line">    "hits" : [ ]</span><br><span class="line">  },</span><br><span class="line">  "suggest" : {</span><br><span class="line">    "my_s4" : [</span><br><span class="line">      {</span><br><span class="line">        "text" : "lucne and elasticsear rock",</span><br><span class="line">        "offset" : 0,</span><br><span class="line">        "length" : 26,</span><br><span class="line">        "options" : [</span><br><span class="line">          {</span><br><span class="line">            "text" : "lucne and elasticsearch rocks",</span><br><span class="line">            "score" : 0.12709484</span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "text" : "lucne and elasticsearch rock",</span><br><span class="line">            "score" : 0.10422645</span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "text" : "lucne and elasticsear rocks",</span><br><span class="line">            "score" : 0.10036137</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>可以看到<code>options</code>直接返回了相关短语列表。虽然<code>lucene</code>建议的并不好。但<code>elasticserch</code>和<code>rock</code>很不错。除此之外，我们还可以使用高亮来向用户展示哪些原有的词条被纠正了。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET s4/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s4": {</span><br><span class="line">      "text": "lucne and elasticsear rock",</span><br><span class="line">      "phrase": {</span><br><span class="line">        "field": "title",</span><br><span class="line">        "highlight":{</span><br><span class="line">          "pre_tag":"&lt;em&gt;",</span><br><span class="line">          "post_tag":"&lt;/em&gt;"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>除了默认的，还可以自定义高亮显示：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET s4/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s4": {</span><br><span class="line">      "text": "lucne and elasticsear rock",</span><br><span class="line">      "phrase": {</span><br><span class="line">        "field": "title",</span><br><span class="line">        "highlight":{</span><br><span class="line">          "pre_tag":"&lt;b id='d1' class='t1' style='color:red;font-size:18px;'&gt;",</span><br><span class="line">          "post_tag":"&lt;/b&gt;"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>需要注意的是，建议器结果的高亮显示和查询结果高亮显示有些许区别，比如说，这里的自定义标签是<code>pre_tag</code>和<code>post_tag</code>而不是之前如这样的：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">GET s4/doc/_search</span><br><span class="line">{</span><br><span class="line">  "query": {</span><br><span class="line">    "match": {</span><br><span class="line">      "title": "rock"</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "highlight": {</span><br><span class="line">    "pre_tags": "&lt;b style='color:red'&gt;",</span><br><span class="line">    "post_tags": "&lt;/b&gt;",</span><br><span class="line">    "fields": {</span><br><span class="line">      "title": {}</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>phrase suggester</code>在<code>term suggester</code>的基础上，会考虑多个<code>term</code>之间的关系，比如是否同时出现索引的原文中，临近程度，词频等。</p>
<h3 id="完成建议器（completion-suggester）">完成建议器（<code>completion suggester</code>）</h3>
<h4 id="前言">前言</h4>
<p>我们来看一下自动完成的建议器——是一个导航功能，提供自动完成、搜索功能，可以在用户输入时引导用户查看相关结果，从而提高搜索精度。<br>
但并不适用于拼接检查或者像<code>term</code>和<code>phrase</code>建议那样的功能。<br>
如果说在2000年左右，自动完成还是很炫酷的功能，那么现在它是必备的了——任何没有自动完成功能的搜索引擎都是很古老的。用户期望一个良好的自动完成来帮助用户实现更快的（特别是移动端）以及更好的（比如输入<code>e</code>，搜索引擎就应该知道用户想要查找的是<code>elasticsearch</code>）搜索。<br>
一个优秀的自动完成将降低搜索引擎的负载，特别是在用户有一些快速搜索可用时，也就是直接跳转到主流的搜索结果而无须执行完整的搜索。<br>
除此之外，一个优秀的自动完成必须是和快速的、相关的：</p>
<ul>
<li>快速是因为它必须在用户不断输入的时候产生建议。</li>
<li>相关则是用户并不希望建议一个没有搜索结果或者没有用处的结果。<br>
那我们依靠之前学过的<code>match_phrase_prefix</code>最左前缀查询来完成该功能，但是这样的查询可能不够快，因为理想的情况下，搜索引擎需要在用户输入下一个字符前返回建议结果。<br>
完成建议器和后面的上下文建议器可以帮助用户构建更快的自动完成，它们是基于<code>Lucene</code>的<code>suggest</code>建议模块而构建的，将数据保存在内存中的有限状态转移机中（FST）。FST实际上是一种图。它可以将词条以压缩和易于检索的方式来存储。<br>
<img src="/img/loading.gif" class="lazyload" data-src="https://img-blog.csdnimg.cn/20200508152415865.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MzE5OTEwMw==,size_16,color_FFFFFF,t_70"  alt="在这里插入图片描述"><br>
上图展示了词条<code>index</code>、<code>search</code>、<code>suggest</code>是如何存储的。当然实际中的实现更加复杂，比如它允许我们添加权重。<br>
FST（Finite StateTransducers），通常中文译作有限状态传感器，FST目前在语音识别和自然语言搜索、处理等方向被广泛应用。<br>
FST的功能更类似于字典，Lucene4.0在查找Term时使用了FST算法，用来快速定位Term的位置。FST的数据结构可以理解成（<code>key:value</code>）的形式。<br>
在同义词过滤器（SynonymFilter）的实现中甚至可以用<code>HashMap</code>代替，不过相比较于<code>HashMap</code>，它的优点是：
<ul>
<li>以O(1)的时间复杂度找到key对应的value。</li>
<li>以字节的方式来存储所有的Term，重复利用Term Index的前缀和后缀，使Term - Index小到可以放进内存，减少存储空间，不过相对的也会占用更多的cpu资源。</li>
<li>FST还可以用来快速确定term是否在系统中。</li>
</ul>
</li>
</ul>
<p><strong>测试数据：创建索引，创建文档。</strong><br>
为了告诉elasticsearch我们准备将建议存储在自动完成的FST中，需要在映射中定义一个字段并将其type类型设置为completion：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">PUT s5</span><br><span class="line">{</span><br><span class="line">  "mappings":{</span><br><span class="line">    "doc":{</span><br><span class="line">      "properties": {</span><br><span class="line">        "title": {</span><br><span class="line">          "type": "completion",</span><br><span class="line">          "analyzer": "standard"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s5/doc/1</span><br><span class="line">{</span><br><span class="line">  "title":"Lucene is cool"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s5/doc/2</span><br><span class="line">{</span><br><span class="line">  "title":"Elasticsearch builds on top of lucene"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s5/doc/3</span><br><span class="line">{</span><br><span class="line">  "title":"Elasticsearch rocks"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s5/doc/4</span><br><span class="line">{</span><br><span class="line">  "title":"Elastic is the company behind ELK stack"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s5/doc/5</span><br><span class="line">{</span><br><span class="line">  "title":"the elk stack rocks"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s5/doc/6</span><br><span class="line">{</span><br><span class="line">  "title":"elasticsearch is rock solid"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET s5/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s5": {</span><br><span class="line">      "text": "elas",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>建议结果不展示了！<br>
上例的特殊映射中，支持以下参数：</p>
<ul>
<li>analyzer，要使用的索引分析器，默认为simple。</li>
<li>search_analyzer，要使用的搜索分析器，默认值为analyzer。</li>
<li>preserve_separators，保留分隔符，默认为true。 如果您禁用，您可以找到以Foo Fighters开头的字段，如果您建议使用foof。</li>
<li>preserve_position_increments，启用位置增量，默认为true。如果禁用并使用停用词分析器The Beatles，如果您建议，可以从一个字段开始b。注意：您还可以通过索引两个输入来实现此目的，Beatles并且 The Beatles，如果您能够丰富数据，则无需更改简单的分析器。</li>
<li>max_input_length，限制单个输入的长度，默认为50UTF-16代码点。此限制仅在索引时使用，以减少每个输入字符串的字符总数，以防止大量输入膨胀基础数据结构。大多数用例不受默认值的影响，因为前缀完成很少超过前缀长于少数几个字符。<br>
除此之外，该建议映射还可以定义在已存在索引字段的多字段：</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">PUT s6</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "doc": {</span><br><span class="line">      "properties": {</span><br><span class="line">        "name": {</span><br><span class="line">          "type": "text",</span><br><span class="line">          "fields": {</span><br><span class="line">            "suggest": {</span><br><span class="line">              "type": "completion"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s6/doc/1</span><br><span class="line">{</span><br><span class="line">  "name":"KFC"</span><br><span class="line">}</span><br><span class="line">PUT s6/doc/2</span><br><span class="line">{</span><br><span class="line">  "name":"kfc"</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">GET s6/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s6": {</span><br><span class="line">      "text": "K",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "name.suggest"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>如上示例中，我们需要索引餐厅这样的地点，而且每个地点的<code>name</code>名称字段添加<code>suggest</code>子字段。<br>
上例的查询将肯德基（KFC）和开封菜（kfc）都返回。</p>
<h4 id="在索引阶段提升相关性">在索引阶段提升相关性</h4>
<p>在进行普通的索引时，输入的文本在索引和搜索阶段都会被分析，这就是为什么上面的示例会将<code>KFC</code>和<code>kfc</code>都返回了。我们也可以通过<code>analyzer</code>和<code>search_analyzer</code>选项来进一步控制分析过程。如上例我们可以只匹配<code>KFC</code>而不匹配<code>kfc</code>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">PUT s7</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "doc": {</span><br><span class="line">      "properties": {</span><br><span class="line">        "name": {</span><br><span class="line">          "type": "text",</span><br><span class="line">          "fields": {</span><br><span class="line">            "suggest": {</span><br><span class="line">              "type": "completion",</span><br><span class="line">              "analyzer":"keyword",</span><br><span class="line">              "search_analyzer":"keyword"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">PUT s7/doc/1</span><br><span class="line">{</span><br><span class="line">  "name":"KFC"</span><br><span class="line">}</span><br><span class="line">PUT s7/doc/2</span><br><span class="line">{</span><br><span class="line">  "name":"kfc"</span><br><span class="line">}</span><br><span class="line">GET s7/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s7": {</span><br><span class="line">      "text": "K",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "name.suggest"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>建议结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 0,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "successful" : 5,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : 0,</span><br><span class="line">    "max_score" : 0.0,</span><br><span class="line">    "hits" : [ ]</span><br><span class="line">  },</span><br><span class="line">  "suggest" : {</span><br><span class="line">    "my_s7" : [</span><br><span class="line">      {</span><br><span class="line">        "text" : "K",</span><br><span class="line">        "offset" : 0,</span><br><span class="line">        "length" : 1,</span><br><span class="line">        "options" : [</span><br><span class="line">          {</span><br><span class="line">            "text" : "KFC",</span><br><span class="line">            "_index" : "s7",</span><br><span class="line">            "_type" : "doc",</span><br><span class="line">            "_id" : "1",</span><br><span class="line">            "_score" : 1.0,</span><br><span class="line">            "_source" : {</span><br><span class="line">              "name" : "KFC"</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>上述的建议结果中，只有<code>KFC</code>被返回。更多的细节控制可以搭配不同的分析器来完成。<br>
多数的情况下，我们将在单独的字段中、单独的索引中甚至是单独的集群中保存建议。这对于主搜索引擎的性能提升和扩展建议器都是非常有利的。</p>
<p>除此之外，还可以使用<code>input</code>和可选的<code>weight</code>属性，<code>input</code>是建议查询匹配的预期文本，<code>weight</code>是建议评分方式（也就是权重）。例如：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">PUT s8</span><br><span class="line">{</span><br><span class="line">  "mappings": {</span><br><span class="line">    "doc":{</span><br><span class="line">      "properties":{</span><br><span class="line">        "title":{</span><br><span class="line">          "type": "completion"</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>添加数据的几种形式：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">PUT s8/doc/1</span><br><span class="line">{</span><br><span class="line">  "title":{</span><br><span class="line">    "input":"blow",</span><br><span class="line">    "weight": 2</span><br><span class="line">  }</span><br><span class="line">}</span><br><span class="line">PUT s8/doc/2</span><br><span class="line">{</span><br><span class="line">  "title":{</span><br><span class="line">    "input":"block",</span><br><span class="line">    "weight": 3</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>上例分别添加两个建议并设置各自的权重值。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">PUT s8/doc/3</span><br><span class="line">{</span><br><span class="line">  "title": [  </span><br><span class="line">    {</span><br><span class="line">      "input":"appel",</span><br><span class="line">      "weight": 2</span><br><span class="line">    },</span><br><span class="line">    {</span><br><span class="line">      "input":"apple",</span><br><span class="line">      "weight": 3</span><br><span class="line">    }</span><br><span class="line">  ]</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>上例以列表的形式添加建议，设置不同的权重。</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PUT s8/doc/4</span><br><span class="line">{</span><br><span class="line">  "title": ["apple", "appel", "block", "blow"],</span><br><span class="line">  "weght": 32</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>上例是为多个建议设置相同的权重。<br>
查询的结果由权重决定：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET s8/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s8": {</span><br><span class="line">      "text": "app",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>比如，我们在设置建议的时候，将<code>apple</code>建议的权重<code>weight</code>设置的更高，那么在如上例的查询中，<code>apple</code>将会排在建议的首位。</p>
<h4 id="在搜索阶段提升相关性">在搜索阶段提升相关性</h4>
<p>当在运行建议的请求时，可以决定出现哪些建议，就像其他建议器一样，<code>size</code>参数控制返回多少项建议（默认为5项）；还可以通过<code>fuzzy</code>参数设置模糊建议，以对拼写进行容错。当开启模糊建议之后，可以设置下列参数来完成建议：</p>
<ul>
<li>fuzziness，可以指定所允许的最大编辑距离。</li>
<li>min_length，指定什么长度的输入文本可以开启模糊查询。</li>
<li>prefix_length，假设若干开始的字符是正确的（比如block，如果输入blaw，该字段也认为之前输入的是对的），这样可以通过牺牲灵活性提升性能。<br>
这些参数都是在建议的<code>completion</code>对象的下面：</li>
</ul>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">GET s8/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "my_s9": {</span><br><span class="line">      "text": "blaw",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "title",</span><br><span class="line">        "size": 2,</span><br><span class="line">        "fuzzy": {</span><br><span class="line">          "fuzziness": 2,</span><br><span class="line">          "min_length": 3,</span><br><span class="line">          "prefix_length": 2</span><br><span class="line">        }</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>结果如下：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">{</span><br><span class="line">  "took" : 0,</span><br><span class="line">  "timed_out" : false,</span><br><span class="line">  "_shards" : {</span><br><span class="line">    "total" : 5,</span><br><span class="line">    "successful" : 5,</span><br><span class="line">    "skipped" : 0,</span><br><span class="line">    "failed" : 0</span><br><span class="line">  },</span><br><span class="line">  "hits" : {</span><br><span class="line">    "total" : 0,</span><br><span class="line">    "max_score" : 0.0,</span><br><span class="line">    "hits" : [ ]</span><br><span class="line">  },</span><br><span class="line">  "suggest" : {</span><br><span class="line">    "my_s9" : [</span><br><span class="line">      {</span><br><span class="line">        "text" : "blow",</span><br><span class="line">        "offset" : 0,</span><br><span class="line">        "length" : 4,</span><br><span class="line">        "options" : [</span><br><span class="line">          {</span><br><span class="line">            "text" : "block",</span><br><span class="line">            "_index" : "s8",</span><br><span class="line">            "_type" : "doc",</span><br><span class="line">            "_id" : "3",</span><br><span class="line">            "_score" : 6.0,</span><br><span class="line">            "_source" : {</span><br><span class="line">              "title" : {</span><br><span class="line">                "input" : "block",</span><br><span class="line">                "weight" : 3</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          },</span><br><span class="line">          {</span><br><span class="line">            "text" : "blow",</span><br><span class="line">            "_index" : "s8",</span><br><span class="line">            "_type" : "doc",</span><br><span class="line">            "_id" : "2",</span><br><span class="line">            "_score" : 4.0,</span><br><span class="line">            "_source" : {</span><br><span class="line">              "title" : {</span><br><span class="line">                "input" : "blow",</span><br><span class="line">                "weight" : 2</span><br><span class="line">              }</span><br><span class="line">            }</span><br><span class="line">          }</span><br><span class="line">        ]</span><br><span class="line">      }</span><br><span class="line">    ]</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h4 id="其他">其他</h4>
<p><code>_source</code><br>
为了减少不必要的响应，我们可以对建议结果做一些过滤，比如加上<code>_source</code>：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">GET s8/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "completion_suggest": {</span><br><span class="line">      "text": "appl",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "_source": "title"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>好吧，虽然我们只有一个字段！</p>
<p><code>size</code><br>
除了<code>_source</code>，我们还可以指定<code>size</code>参数：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GET s8/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "completion_suggest": {</span><br><span class="line">      "prefix": "app",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "title",</span><br><span class="line">        "size": 1</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "_source": "title"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p><code>size</code>参数指定返回建议数（默认为5），需要注意的是，<code>size must be positive</code>，也就是说<code>size</code>参数必须是积极的——非0非负数！</p>
<p><strong>skip_duplicates</strong><br>
我们的建议可能是来自不同的文档，这其中就会有一些重复建议项，我们可以通过设置<code>skip_duplicates:true</code>来修改此行为，如果为<code>true</code>则会过滤掉结果中的重复建议文档：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">GET s8/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "completion_suggest": {</span><br><span class="line">      "prefix": "app",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "title",</span><br><span class="line">        "size": 5,</span><br><span class="line">        "skip_duplicates":true</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  },</span><br><span class="line">  "_source": "title"</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<p>但需要注意的是，该参数设置为<code>true</code>的话，可能会降低搜索速度，因为需要访问更多的建议结果项，才能过滤出来前N个。<br>
最后，完成建议器还支持正则表达式查询，这意味着我们可以将前缀表示为正则表达式：</p>
<figure class="highlight plain"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">GET s5/doc/_search</span><br><span class="line">{</span><br><span class="line">  "suggest": {</span><br><span class="line">    "completion_suggest": {</span><br><span class="line">      "regex": "e[l|e]a",</span><br><span class="line">      "completion": {</span><br><span class="line">        "field": "title"</span><br><span class="line">      }</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">L1uNan</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://nanpy.top/posts/9bd4ee27.html">http://nanpy.top/posts/9bd4ee27.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://nanpy.top" target="_blank">NanPy</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/ElasticSearch/">ElasticSearch</a></div><div class="post_share"><div class="social-share" data-image="http://cnd.nanpy.top/post5.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><div class="post-reward"><a class="reward-button button--primary button--animated"> <i class="fa fa-qrcode"></i> 打赏<div class="reward-main"><ul class="reward-all"><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/wechat.jpg" alt="微信"/><div class="post-qr-code__desc">微信</div></li><li class="reward-item"><img class="lazyload post-qr-code__img" src="/img/alipay.jpg" alt="支付宝"/><div class="post-qr-code__desc">支付宝</div></li></ul></div></a></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="/posts/a3a30c9.html"><img class="prev_cover lazyload" data-src="http://cnd.nanpy.top/post18.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">python的GIL是什么东西？</div></div></a></div><div class="next-post pull_right"><a href="/posts/5dd0a337.html"><img class="next_cover lazyload" data-src="http://cnd.nanpy.top/post14.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">分页器封装</div></div></a></div></nav><div class="relatedPosts"><div class="relatedPosts_headline"><i class="fa fa-fw fa-thumbs-up" aria-hidden="true"></i><span> 相关推荐</span></div><div class="relatedPosts_list"><div class="relatedPosts_item"><a href="/posts/9876eec9.html" title="ElasticSearch + Kibana 搭建kibana起不来！"><img class="relatedPosts_cover lazyload"data-src="http://cnd.nanpy.top/post21.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-16</div><div class="relatedPosts_title">ElasticSearch + Kibana 搭建kibana起不来！</div></div></a></div><div class="relatedPosts_item"><a href="/posts/5367c5d9.html" title="ElasticSearch的基本操作"><img class="relatedPosts_cover lazyload"data-src="http://cnd.nanpy.top/post4.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-27</div><div class="relatedPosts_title">ElasticSearch的基本操作</div></div></a></div><div class="relatedPosts_item"><a href="/posts/201d68ba.html" title="elasticsearch使用Python批量写入数据"><img class="relatedPosts_cover lazyload"data-src="http://cnd.nanpy.top/post.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-05-04</div><div class="relatedPosts_title">elasticsearch使用Python批量写入数据</div></div></a></div><div class="relatedPosts_item"><a href="/posts/51d13a3a.html" title="python操作es"><img class="relatedPosts_cover lazyload"data-src="http://cnd.nanpy.top/post20.jpg"><div class="relatedPosts_main is-center"><div class="relatedPosts_date"><i class="fa fa-calendar fa-fw" aria-hidden="true"></i> 2020-04-30</div><div class="relatedPosts_title">python操作es</div></div></a></div></div><div class="clear_both"></div></div><hr><div id="post-comment"><div class="comment_headling"><i class="fa fa-comments fa-fw" aria-hidden="true"></i><span> 评论</span></div><div class="vcomment" id="vcomment"></div><script src="https://cdn.jsdelivr.net/npm/valine/dist/Valine.min.js"></script><script>var GUEST_INFO = ['nick','mail','link'];
var guest_info = 'nick,mail,link'.split(',').filter(function(item){
  return GUEST_INFO.indexOf(item) > -1
});
guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;

window.valine = new Valine({
  el:'#vcomment',
  notify: true,
  verify: true,
  appId: 'OH7ASE912LXCvuRN4MLX5Gik-gzGzoHsz',
  appKey: 'MS2dI4bwNwlpOjl4n4urQOrc',
  placeholder: '如果你留下准确的联系方式，你将很快收到回复。',
  avatar: 'monsterid',
  meta: guest_info,
  pageSize: '10',
  lang: 'zh-cn',
  recordIP: false,
  serverURLs: ''
});</script></div></article></main><footer id="footer" style="background-image: url(http://cnd.nanpy.top/post11.jpg)" data-type="photo"><div id="footer-wrap"><div class="copyright">&copy;2020 By L1uNan</div><div class="footer_custom_text"><p>By L1uNan</p></div><div class="icp"><a href="http://www.beian.miit.gov.cn/state/outPortal/loginPortal.action" target="_blank" rel="noopener"><img class="icp-icon" src="/img/icp.png"/><span>京ICP备20016102号-1</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><a id="to_comment" href="#post-comment" title="直达评论"><i class="scroll_to_comment fa fa-comments">  </i></a><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" target="_blank" rel="noopener" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="/js/third-party/fireworks.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar/dist/snackbar.min.js"></script><script id="canvas_nest" color="0,0,255" opacity="0.7" zIndex="-1" count="99" mobile="false" src="/js/third-party/canvas-nest.js"></script><script src="/js/third-party/activate-power-mode.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
document.body.addEventListener('input', POWERMODE);
</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="https://cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script src="/js/search/local-search.js"></script></body></html>